<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Carteirinha Estudantil</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f5f5f5;
    }

    input {
      padding: 10px;
      font-size: 16px;
      width: 220px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }

    canvas {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      display: block;
      background: #ddd;
      border-radius: 10px;
    }
  </style>
</head>

<body>

<h2>Carteirinha Estudantil</h2>

<input type="text" id="cpf" placeholder="Digite seu CPF">
<br>
<button onclick="verificar()">Acessar</button>

<!-- FRENTE -->
<canvas id="frente" width="800" height="500"></canvas>

<!-- VERSO -->
<canvas id="verso" width="800" height="500"></canvas>

<!-- Bibliotecas -->
<script src="https://cdn.jsdelivr.net/npm/js-sha256"></script>
<script src="alunos.js"></script>

<script>
/* ==========================
   CANVAS
========================== */
const canvasFrente = document.getElementById("frente");
const ctxFrente = canvasFrente.getContext("2d");

const canvasVerso = document.getElementById("verso");
const ctxVerso = canvasVerso.getContext("2d");

/* ==========================
   LIMPAR
========================== */
function limpar() {
  ctxFrente.clearRect(0, 0, canvasFrente.width, canvasFrente.height);
  ctxVerso.clearRect(0, 0, canvasVerso.width, canvasVerso.height);
}

/* ==========================
   FUNÇÃO PRINCIPAL
========================== */
function verificar() {
  const cpf = document.getElementById("cpf").value.replace(/\D/g, '');
  const hash = sha256(cpf);

  const aluno = alunos.find(a => a.hash === hash);

  limpar();

  if (!aluno) {
    ctxFrente.font = "20px Arial";
    ctxFrente.fillStyle = "red";
    ctxFrente.fillText("Aluno não encontrado", 280, 250);
    return;
  }

  desenharFrente(aluno);
  desenharVerso();
}

/* ==========================
   FUNÇÃO AUXILIAR PARA TEXTOS
========================== */
function desenharTextos(aluno) {
  ctxFrente.fillStyle = "#000";

  ctxFrente.font = "bold 28px Arial";
  ctxFrente.fillText(aluno.nome, 350, 130);

  ctxFrente.font = "24px Arial";
  ctxFrente.fillText(aluno.instituicao, 450, 190);
  ctxFrente.fillText(aluno.curso, 450, 245);
  ctxFrente.fillText(aluno.cidade, 450, 300);
  ctxFrente.fillText(aluno.turno, 450, 357);
  ctxFrente.fillText(aluno.validade, 450, 420);

  // MATRÍCULA VERTICAL
  ctxFrente.save();
  ctxFrente.translate(82, 320);
  ctxFrente.rotate(-Math.PI / 2);
  ctxFrente.font = "24px Arial";
  ctxFrente.fillText(aluno.matricula, 0, 0);
  ctxFrente.restore();
}

/* ==========================
   FRENTE - MODIFICADA
========================== */
function desenharFrente(aluno) {
  const fundo = new Image();
  const foto = new Image();
  
  // Primeiro carrega o fundo
  fundo.onload = () => {
    ctxFrente.drawImage(fundo, 0, 0, canvasFrente.width, canvasFrente.height);
    
    // Depois carrega a foto
    foto.onload = () => {
      ctxFrente.drawImage(foto, 125, 195, 160, 180);
      
      // Agora desenha os textos
      desenharTextos(aluno);
    };
    
    // Se a foto não carregar
    foto.onerror = () => {
      console.error("Erro ao carregar foto do aluno:", aluno.matricula);
      ctxFrente.fillStyle = "#ccc";
      ctxFrente.fillRect(125, 195, 160, 180);
      ctxFrente.fillStyle = "#666";
      ctxFrente.font = "16px Arial";
      ctxFrente.fillText("Sem foto", 165, 285);
      
      // Continua desenhando os textos mesmo sem foto
      desenharTextos(aluno);
    };
    
    foto.src = "imagens/fotos/" + aluno.matricula + ".jpg";
  };
  
  // Se o fundo não carregar
  fundo.onerror = () => {
    console.error("Erro ao carregar modelo-frente.png");
    ctxFrente.fillStyle = "#eee";
    ctxFrente.fillRect(0, 0, canvasFrente.width, canvasFrente.height);
    ctxFrente.fillStyle = "red";
    ctxFrente.font = "20px Arial";
    ctxFrente.fillText("Erro: modelo-frente.png não encontrado", 150, 250);
    ctxFrente.fillText("Verifique se a pasta 'imagens/' existe", 150, 280);
  };
  
  fundo.src = "imagens/modelo-frente.png";
}

/* ==========================
   VERSO - MODIFICADA
========================== */
function desenharVerso() {
  const fundo = new Image();
  
  fundo.onload = () => {
    ctxVerso.drawImage(fundo, 0, 0, canvasVerso.width, canvasVerso.height);
  };
  
  fundo.onerror = () => {
    console.error("Erro ao carregar modelo-verso.png");
    ctxVerso.fillStyle = "#eee";
    ctxVerso.fillRect(0, 0, canvasVerso.width, canvasVerso.height);
    ctxVerso.fillStyle = "red";
    ctxVerso.font = "20px Arial";
    ctxVerso.fillText("Erro: modelo-verso.png não encontrado", 150, 250);
    ctxVerso.fillText("Verifique se a pasta 'imagens/' existe", 150, 280);
  };
  
  fundo.src = "imagens/modelo-verso.png";
}
</script>

</body>
</html>
